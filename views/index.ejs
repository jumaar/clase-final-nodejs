<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Login & registration Forms`</title>
    <!-- google fonts -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Roboto:ital,wght@0,100..900;1,100..900&display=swap" rel="stylesheet">
    <!-- Vinculamos la hoja de estilos principal -->
    <link rel="stylesheet" href="/css/main.css">
</head>
<body>
    <button id="theme-toggle-button" class="theme-toggle-button">🌙</button>
    <div class="container">
        <% if (typeof username !== 'undefined') { %>
            <div class="form-container">
                <h2>Hola <%= username %>!</h2>
                <p>Estas en el panel de administracion</p>
                <button id="close-session">Cerrar sesion</button>
            </div>
        <% } %>

            <% if (typeof username === 'undefined') { %>
                <!-- Contenedor del Login (Visible por defecto) -->
                <div id="login-container">
                    <div class="form-container">
                        <form id="login-form">
                            <h2>Login</h2>
                            <label for="login-username">Username</label>
                            <input type="text" id="login-username" name="username" required>
                            <label for="login-password">Password</label>
                            <input type="password" id="login-password" name="password" required>
                            <button type="submit">Login</button>
                            <span class="form-message">&nbsp;</span>
                        </form>
                        <p class="toggle-link">¿No tienes cuenta? <a href="#" id="show-register-link">Regístrate</a></p>
                    </div>
                </div>

                <!-- Contenedor del Registro (Oculto por defecto) -->
                <div id="register-container" style="display: none;">
                    <div class="form-container">
                        <form id="register-form">
                            <h2>Register</h2>
                            <label for="register-username">Username</label>
                            <input type="text" id="register-username" name="username" required>
                            <label for="register-password">Password</label>
                            <input type="password" id="register-password" name="password" required>
                            <label for="register-confirm-password">Confirm Password</label>
                            <input type="password" id="register-confirm-password" name="confirm-password" required>
                            <button type="submit">Register</button>
                            <span class="form-message">&nbsp;</span>
                        </form>
                        <p class="toggle-link">¿Ya tienes cuenta? <a href="#" id="show-login-link">Inicia sesión</a></p>
                    </div>
                </div>
          <% } %>    
    </div>
    <script>
        const $ = el => document.querySelector(el)

        // --- Lógica para alternar formularios ---
        const loginContainer = $('#login-container')
        const registerContainer = $('#register-container')
        const showRegisterLink = $('#show-register-link')
        const showLoginLink = $('#show-login-link')

        showRegisterLink?.addEventListener('click', e => {
            e.preventDefault()
            loginContainer.style.display = 'none'
            registerContainer.style.display = 'block'
        })

        showLoginLink?.addEventListener('click', e => {
            e.preventDefault()
            registerContainer.style.display = 'none'
            loginContainer.style.display = 'block'
        })

        // --- Lógica de la Aplicación ---
        const loginForm = $('#login-form')
        const loginSpan = $('#login-form .form-message')
        const registerForm = $('#register-form')
        const registerSpan = $('#register-form .form-message')
        const logoutButton = $('#close-session')

        // --- Lógica de Forms (Login/Register/Logout) ---
        loginForm?.addEventListener('submit', e => {
            e.preventDefault()
            const username = $('#login-username').value
            const password = $('#login-password').value
            
            fetch('/login', {
                method: 'POST',
                headers:{ 'Content-Type': 'application/json' },
                body: JSON.stringify({ username, password })
            })
            .then(res => {
                if (res.ok) {
                    loginSpan.innerText = 'Sesión Iniciada... Entrando...'
                    loginSpan.style.color = 'green'
                    setTimeout(() => { window.location.href = '/chat' }, 1200)
                } else {
                    loginSpan.innerText = 'Error al iniciar sesión'
                    loginSpan.style.color = 'red'
                }
            })
        })
        
        registerForm?.addEventListener('submit', e => {
            e.preventDefault()
            const username = $('#register-username').value
            const password = $('#register-password').value
            const confirmPassword = $('#register-confirm-password').value

            if (password !== confirmPassword) {
                alert('Las contraseñas no coinciden')
                return
            }

            fetch('/register', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ username, password })
            })
            .then(res => {
                if(res.ok) {
                    // Si el registro es exitoso, el servidor ya ha iniciado la sesión.
                    // Simplemente mostramos un mensaje y redirigimos.
                    registerSpan.innerText = 'Usuario Registrado. Entrando...'
                    registerSpan.style.color = 'green'
                    setTimeout(() => {
                        window.location.href = '/chat'
                    }, 1200)
                } else {
                    // Si hay un error, lo mostramos.
                    res.json().then(data => {
                        registerSpan.innerText = data.error
                        registerSpan.style.color = 'red'
                    })
                }
            })
        })

        logoutButton?.addEventListener('click', e => {
            e.preventDefault()
            fetch('/logout', {
                method: 'POST',
                headers:{ 'Content-Type': 'application/json' }
            })
            .then(res => {
                if (res.ok) {
                    window.location.href = '/'
                }
            })
        })
    </script>
    <script src="/js/theme-switcher.js"></script>
</body>
</html>